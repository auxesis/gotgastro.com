#!/usr/bin/env ruby
#

require 'rubygems'
require 'bundler/setup'
require 'geokit'
require 'extlib'
require 'data_mapper'
require 'open-uri'

DataMapper::Logger.new($stdout, :debug)

database_path = (Pathname.new(__FILE__).parent.parent + 'data' + 'nswfa-penalty_notices.sqlite').expand_path
DataMapper.setup(:default, "sqlite:///#{database_path}")

class Penalty
  include DataMapper::Resource

  storage_names[:default] = "swdata"

  property :id,           String, :key => true
  property :notice,       String
  property :code,         String
  property :party_served, String
  property :notes,        String
  property :issued_by,    String
  property :date_served,  String
  property :penalty,      String
  property :suburb,       String
  property :trade_name,   String
  property :council,      String
  property :address,      String
  property :date,         String
  property :details_link, String
  property :latitude,     String
  property :longitude,    String
  property :date_scraped, String

  def geocode(opts={})
    force = opts[:force]

    if !self.latitude.blank? && !self.longitude.blank? && !force
      return [self.latitude, self.longitude ]
    end

    tries = 3
    begin
      location = ::Geokit::Geocoders::MultiGeocoder.geocode(self.address)
    rescue ::OpenURI::HTTPError
      retry if (tries =- 1) > 0
    end

    if location
      self.latitude  = location.lat
      self.longitude = location.lng
    else
      return false
    end

    [ self.latitude, self.longitude ]
  end
end

if __FILE__ == $0 then

  penalties = Penalty.all

  penalties.each do |penalty|
    print "Geocoding #{penalty.id} "
    p penalty.geocode
    penalty.save!
  end

end


